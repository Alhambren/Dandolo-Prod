<!DOCTYPE html>
<html>
<head>
    <title>Streaming Debug Test</title>
    <script src="https://unpkg.com/convex@1.16.2/dist/browser.js"></script>
</head>
<body>
    <h1>Streaming Debug Test</h1>
    <div id="output"></div>
    
    <script>
        const convex = new ConvexClient("https://good-monitor-677.convex.cloud");
        
        async function debugStreaming() {
            try {
                const output = document.getElementById('output');
                output.innerHTML = '<p>üîç Testing streaming functionality...</p>';
                
                // Test 1: Check providers
                console.log('Checking providers...');
                const providers = await convex.action("debug:checkProviders", {});
                console.log('Providers result:', providers);
                output.innerHTML += `<p>‚úÖ Found ${providers.activeCount} active providers</p>`;
                
                if (providers.activeCount === 0) {
                    output.innerHTML += '<p>‚ùå No active providers - streaming will fail</p>';
                    return;
                }
                
                // Test 2: Test streaming chunks
                console.log('Testing streaming chunks...');
                const chunksTest = await convex.action("debug:testStreamingChunks", {});
                console.log('Chunks test result:', chunksTest);
                output.innerHTML += `<p>‚úÖ Streaming chunks test: ${chunksTest.success ? 'PASSED' : 'FAILED'}</p>`;
                
                if (!chunksTest.success) {
                    output.innerHTML += `<p>‚ùå Error: ${chunksTest.error}</p>`;
                    return;
                }
                
                // Test 3: Try actual streaming
                console.log('Testing actual streaming...');
                const sessionId = `test_session_${Date.now()}`;
                
                const streamResult = await convex.action("inference:sendMessageStreaming", {
                    messages: [{ role: 'user', content: 'Say "Hello test!" and nothing else.' }],
                    model: 'venice-uncensored',
                    sessionId: sessionId,
                    allowAdultContent: false
                });
                
                console.log('Stream result:', streamResult);
                
                if (streamResult.success && streamResult.streamId) {
                    output.innerHTML += `<p>‚úÖ Streaming started with ID: ${streamResult.streamId}</p>`;
                    
                    // Poll for chunks
                    let attempts = 0;
                    const maxAttempts = 10;
                    let totalContent = '';
                    
                    const pollInterval = setInterval(async () => {
                        attempts++;
                        
                        try {
                            const chunks = await convex.query("inference:getStreamingChunks", {
                                streamId: streamResult.streamId
                            });
                            
                            console.log(`Attempt ${attempts}: Found ${chunks.length} chunks`);
                            
                            if (chunks.length > 0) {
                                for (const chunk of chunks) {
                                    if (chunk.content) {
                                        totalContent += chunk.content;
                                    }
                                    
                                    if (chunk.done) {
                                        clearInterval(pollInterval);
                                        output.innerHTML += `<p>‚úÖ Streaming completed!</p>`;
                                        output.innerHTML += `<p>üìÑ Response: "${totalContent}"</p>`;
                                        output.innerHTML += `<p>üî¢ Tokens: ${chunk.tokens || 'Unknown'}</p>`;
                                        return;
                                    }
                                }
                                
                                if (totalContent) {
                                    output.innerHTML += `<p>üìù Current: "${totalContent.substring(0, 100)}${totalContent.length > 100 ? '...' : ''}"</p>`;
                                }
                            }
                            
                            if (attempts >= maxAttempts) {
                                clearInterval(pollInterval);
                                output.innerHTML += '<p>‚ö†Ô∏è Streaming timeout</p>';
                                output.innerHTML += `<p>üìÑ Partial: "${totalContent}"</p>`;
                            }
                        } catch (error) {
                            console.error('Polling error:', error);
                        }
                    }, 1000);
                    
                } else {
                    output.innerHTML += `<p>‚ùå Streaming failed: ${streamResult.error || 'Unknown error'}</p>`;
                }
                
            } catch (error) {
                console.error('Test failed:', error);
                document.getElementById('output').innerHTML += `<p>‚ùå Test failed: ${error.message}</p>`;
            }
        }
        
        // Run the test when page loads
        window.onload = debugStreaming;
    </script>
</body>
</html>